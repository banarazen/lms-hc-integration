<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Zenoti ‚Äì Lead Management Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
:root {
  --teal:#2D9D8F; --teal-light:#EDFAF8; --teal-dark:#1C5E56; --teal2:#3ABDB1;
  --blue:#3B82F6; --blue-light:#EFF6FF;
  --amber:#F59E0B; --amber-light:#FFFBEB;
  --red:#EF4444; --red-light:#FEF2F2;
  --green:#10B981; --green-light:#ECFDF5;
  --purple:#8B5CF6; --purple-light:#F5F3FF;
  --gray:#64748B; --gray-light:#F8FAFC; --border:#E2E8F0;
  --text:#0F172A; --text-muted:#64748B; --text-light:#94A3B8;
  --bg:#F0F4F8; --card:#FFFFFF;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
.card{background:var(--card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);padding:20px}
.card-sm{padding:14px}

/* Header */
header{background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
.logo{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--teal),var(--teal-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;flex-shrink:0}
.header-title{font-weight:700;font-size:14px;color:var(--text)}
.date-pills{display:flex;background:#F1F5F9;border-radius:10px;padding:3px;gap:2px}
.date-pill{padding:4px 10px;border-radius:8px;font-size:11px;font-weight:500;cursor:pointer;color:var(--text-muted);border:none;background:transparent;transition:all .15s;font-family:inherit}
.date-pill.active{background:var(--teal);color:#fff}
.filter-select{font-size:11px;border:1.5px solid var(--border);border-radius:8px;padding:5px 8px;outline:none;font-family:inherit;color:var(--text);background:#fff;cursor:pointer;transition:border-color .15s}
.filter-select:focus{border-color:var(--teal)}
.btn-ghost{font-size:11px;border:1px solid var(--border);border-radius:8px;padding:6px 12px;background:#fff;cursor:pointer;color:var(--text-muted);font-family:inherit;transition:all .15s}
.btn-ghost:hover{background:#F8FAFC}
/* Active filter chip */
.filter-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:500;background:var(--teal-light);color:var(--teal-dark);border:1px solid var(--teal)}
.filter-chip button{background:none;border:none;cursor:pointer;color:var(--teal);font-size:12px;line-height:1;padding:0;margin-left:2px}
/* Search highlight */
.search-highlight{background:#FEF9C3;border-radius:2px}

/* Layout */
main{max-width:1600px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:20px}

/* KPI Strip */
.kpi-strip{display:flex;gap:12px;overflow-x:auto;padding-bottom:4px}
.kpi-strip::-webkit-scrollbar{height:4px}
.kpi-strip::-webkit-scrollbar-track{background:transparent}
.kpi-strip::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.kpi-card{min-width:160px;flex-shrink:0;padding:16px;border-radius:12px;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.08);cursor:default;transition:transform .2s,box-shadow .2s;animation:fadeUp .4s ease both}
.kpi-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
.kpi-card.alert-card{outline:2px solid var(--amber);outline-offset:0}
.kpi-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;margin-bottom:10px}
.kpi-value{font-size:24px;font-weight:800;color:var(--text);margin-bottom:4px}
.kpi-label{font-size:11px;font-weight:500;color:var(--text-muted);margin-bottom:6px}
.kpi-sub{font-size:11px;color:var(--text-light)}
.delta-up{color:var(--green);font-size:11px;font-weight:600}
.delta-down{color:var(--red);font-size:11px;font-weight:600}

/* Grid layouts */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media(max-width:900px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}

/* Section headers */
.section-hdr{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.section-icon{width:30px;height:30px;border-radius:8px;background:var(--teal-light);color:var(--teal);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.section-title{font-size:14px;font-weight:700;color:var(--text)}
.section-sub{font-size:11px;color:var(--text-muted);margin-top:1px}
.section-badge{margin-left:auto;padding:3px 10px;border-radius:20px;font-size:10px;font-weight:700;background:var(--purple-light);color:var(--purple)}

/* Tags / Badges */
.badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:600}
.badge-teal{background:var(--teal-light);color:var(--teal-dark)}
.badge-blue{background:var(--blue-light);color:var(--blue)}
.badge-amber{background:var(--amber-light);color:var(--amber)}
.badge-red{background:var(--red-light);color:var(--red)}
.badge-purple{background:var(--purple-light);color:var(--purple)}
.badge-green{background:var(--green-light);color:var(--green)}

/* Funnel */
.funnel-stage{border-radius:10px;padding:12px;cursor:pointer;margin-bottom:8px;transition:all .2s}
.funnel-stage:hover{opacity:.9}
.funnel-bar-wrap{height:22px;background:rgba(255,255,255,.5);border-radius:6px;overflow:hidden;margin-top:6px}
.funnel-bar{height:100%;border-radius:6px;transition:width .8s ease}
.funnel-stage-name{font-size:12px;font-weight:700}
.funnel-meta{display:flex;justify-content:space-between;align-items:center}
.funnel-count{font-size:16px;font-weight:800}
.drop-off-hi{color:var(--red);font-size:11px;font-weight:600}
.drop-off-md{color:var(--amber);font-size:11px;font-weight:600}
.pipeline-total{background:var(--teal-light);border-radius:10px;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:12px}
.pipeline-total b{color:var(--teal);font-size:14px;font-weight:700}

/* Source table */
.data-table{width:100%;border-collapse:collapse;font-size:12px}
.data-table th{text-align:left;padding:8px 6px;border-bottom:2px solid var(--border);color:var(--text-muted);font-weight:600;cursor:pointer;white-space:nowrap;font-size:11px}
.data-table th:hover{color:var(--text)}
.data-table td{padding:10px 6px;border-bottom:1px solid #F1F5F9}
.data-table tr:hover td{background:#FAFBFC}
.conv-hi{color:var(--green);font-weight:600}
.conv-md{color:var(--amber);font-weight:600}
.conv-lo{color:var(--red);font-weight:600}
.src-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px;flex-shrink:0}

/* AI vs Human */
.ai-metric-row{display:grid;grid-template-columns:2fr 1fr 40px 1fr;gap:4px;align-items:center;padding:8px 0;border-bottom:1px solid #F8FAFC;font-size:12px}
.ai-metric-label{color:var(--text-muted);font-weight:500}
.ai-val{text-align:center;font-weight:700;padding:4px 8px;border-radius:8px}
.ai-val.winner{background:var(--teal-light);color:var(--teal-dark)}
.ai-val.loser{color:var(--text-muted)}
.human-val{text-align:center;font-weight:700;padding:4px 8px;border-radius:8px}
.human-val.winner{background:var(--blue-light);color:var(--blue)}
.human-val.loser{color:var(--text-muted)}
.vs-sep{text-align:center;color:var(--text-light);font-size:10px;font-weight:500}
.ai-header-box{text-align:center;padding:10px;border-radius:10px;background:#F0FDF4;margin-bottom:12px}
.human-header-box{text-align:center;padding:10px;border-radius:10px;background:var(--blue-light);margin-bottom:12px}

/* Agent leaderboard */
.agent-row{border-radius:12px;padding:12px;cursor:pointer;transition:all .15s;border:1.5px solid transparent;margin-bottom:8px}
.agent-row:hover{background:#FAFBFC;border-color:var(--border)}
.agent-row.active{background:var(--teal-light);border-color:var(--teal)}
.agent-avatar{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0}
.agent-rank{font-size:22px;font-weight:900;color:#E2E8F0;width:28px;flex-shrink:0}
.agent-detail{display:none;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,.06)}
.agent-row.active .agent-detail{display:grid}
.agent-stat{text-align:center}
.agent-stat-val{font-size:13px;font-weight:700;color:var(--text)}
.agent-stat-lbl{font-size:10px;color:var(--text-muted);margin-top:2px}

/* Chart toggle tabs */
.tab-pills{display:flex;gap:4px}
.tab-pill{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;border:none;background:#F1F5F9;color:var(--text-muted);transition:all .15s;font-family:inherit}
.tab-pill.active{background:var(--teal);color:#fff}

/* Lead type bars */
.type-row{margin-bottom:10px}
.type-bar-bg{height:8px;background:#F1F5F9;border-radius:4px;overflow:hidden;margin-top:4px}
.type-bar-fill{height:100%;border-radius:4px;transition:width .7s ease}
.type-meta{display:flex;justify-content:space-between;align-items:center;font-size:11px}

/* Center cards */
.center-card{border-radius:12px;padding:14px;border:1.5px solid var(--border);transition:border-color .15s}
.center-card:hover{border-color:var(--teal)}
.center-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:10px;text-align:center}
.center-stat{background:#F8FAFC;border-radius:8px;padding:8px}
.center-stat-val{font-size:14px;font-weight:700;color:var(--text)}
.center-stat-lbl{font-size:10px;color:var(--text-muted);margin-top:2px}
.center-stat.at-risk-hi{background:var(--red-light)}
.center-stat.at-risk-hi .center-stat-val{color:var(--red)}
.center-stat.at-risk-md{background:var(--amber-light)}
.center-stat.at-risk-md .center-stat-val{color:var(--amber)}

/* Nurture */
.nurture-channel{border-radius:10px;padding:14px;border:1.5px solid var(--border)}
.nurture-metric{display:flex;justify-content:space-between;font-size:11px;margin-bottom:6px}
.nurture-metric-lbl{color:var(--text-muted)}
.nurture-metric-val{font-weight:600;color:var(--text)}
.progress-bar{height:6px;background:#F1F5F9;border-radius:3px;overflow:hidden;margin-top:6px}
.progress-fill{height:100%;border-radius:3px;transition:width .7s ease;background:var(--teal)}

/* Risk cards */
.risk-card{border-radius:10px;padding:12px;background:#fff;border:1.5px solid var(--border);border-left:4px solid var(--amber);margin-bottom:8px;transition:all .2s}
.risk-card.critical{border-left-color:var(--red)}
.risk-card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
.risk-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.btn-action{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:600;cursor:pointer;border:1.5px solid;transition:all .15s;font-family:inherit}
.btn-primary{background:var(--teal);color:#fff;border-color:var(--teal)}
.btn-primary:hover{opacity:.9}
.btn-outline{background:#fff;color:var(--teal);border-color:var(--teal)}
.btn-outline:hover{background:var(--teal-light)}
.btn-muted{background:#fff;color:var(--text-muted);border-color:var(--border)}
.btn-muted:hover{background:#F8FAFC}
.btn-dismiss{background:#fff;color:var(--text-light);border-color:var(--border);margin-left:auto}

/* Chatbot */
#chat-fab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--teal);color:#fff;border:none;cursor:pointer;font-size:22px;box-shadow:0 4px 20px rgba(45,157,143,.4);transition:transform .2s;z-index:200;display:flex;align-items:center;justify-content:center}
#chat-fab:hover{transform:scale(1.1)}
#chat-panel{position:fixed;bottom:16px;right:16px;width:380px;max-height:88vh;background:#FAFBFC;border-radius:18px;box-shadow:0 8px 40px rgba(0,0,0,.15);z-index:200;display:none;flex-direction:column;overflow:hidden;border:1px solid var(--border)}
#chat-panel.open{display:flex}
.chat-header{background:linear-gradient(135deg,var(--teal),var(--teal-dark));padding:12px 16px;display:flex;align-items:center;gap:10px;color:#fff;flex-shrink:0}
.chat-avatar{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:16px}
.chat-header-info{flex:1}
.chat-header-name{font-size:13px;font-weight:600}
.chat-header-sub{font-size:10px;opacity:.75}
.chat-close{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.2);border:none;color:#fff;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:background .15s}
.chat-close:hover{background:rgba(255,255,255,.3)}
.chat-messages{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:10px;min-height:160px;max-height:320px}
.chat-messages::-webkit-scrollbar{width:4px}
.chat-messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.msg-wrap{display:flex;gap:8px;animation:fadeUp .3s ease}
.msg-wrap.user{flex-direction:row-reverse}
.msg-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;color:#fff}
.msg-icon.ai{background:var(--teal);font-size:14px}
.msg-icon.user{background:var(--blue)}
.msg-bubble{max-width:72%;padding:10px 12px;border-radius:14px;font-size:12px;line-height:1.55;white-space:pre-wrap}
.msg-bubble.ai{background:#fff;border:1px solid var(--border);color:var(--text);border-top-left-radius:4px}
.msg-bubble.user{background:var(--blue);color:#fff;border-top-right-radius:4px}
.msg-action{display:block;margin-top:8px;padding:6px 12px;background:var(--teal);color:#fff;border:none;border-radius:8px;font-size:11px;font-weight:600;cursor:pointer;width:100%;font-family:inherit;transition:opacity .15s}
.msg-action:hover{opacity:.9}
.thinking{display:flex;align-items:center;gap:4px;padding:10px 14px;background:#fff;border:1px solid var(--border);border-radius:14px;border-top-left-radius:4px}
.dot{width:7px;height:7px;border-radius:50%;background:var(--teal);animation:bounce 1s infinite}
.dot:nth-child(2){animation-delay:.2s}
.dot:nth-child(3){animation-delay:.4s}
.chat-chips{border-top:1px solid var(--border);padding:10px;flex-shrink:0}
.chip-cats{display:flex;gap:6px;overflow-x:auto;padding-bottom:6px}
.chip-cats::-webkit-scrollbar{display:none}
.chip-cat{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:500;cursor:pointer;white-space:nowrap;border:none;background:#F1F5F9;color:var(--text-muted);font-family:inherit;transition:all .15s;flex-shrink:0}
.chip-cat.active{background:var(--teal);color:#fff}
.chip-list{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.chip{padding:5px 10px;border-radius:14px;font-size:11px;font-weight:500;cursor:pointer;border:1.5px solid var(--teal);color:var(--teal);background:var(--teal-light);transition:all .15s;font-family:inherit}
.chip:hover{background:var(--teal);color:#fff;transform:translateY(-1px)}
.chat-input-row{border-top:1px solid var(--border);padding:10px;display:flex;gap:8px;flex-shrink:0}
.chat-input{flex:1;border:1.5px solid var(--border);border-radius:10px;padding:8px 12px;font-size:12px;outline:none;font-family:inherit;transition:border-color .15s}
.chat-input:focus{border-color:var(--teal)}
.chat-send{width:36px;height:36px;border-radius:10px;background:var(--teal);color:#fff;border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:opacity .15s;flex-shrink:0}
.chat-send:hover{opacity:.85}
.chat-powered{text-align:center;font-size:10px;color:var(--text-light);padding:4px 0 2px}

/* Animations */
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.fade-up{animation:fadeUp .4s ease both}

/* Loading */
#loading{position:fixed;inset:0;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px}
#loading .logo-big{width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,var(--teal),var(--teal-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-size:24px;font-weight:800}
#loading p{color:var(--text-muted);font-size:13px}
.spinner{width:32px;height:32px;border:3px solid var(--teal-light);border-top-color:var(--teal);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Pie legend */
.pie-legend{display:flex;flex-direction:column;gap:8px;flex:1;min-width:0}
.pie-legend-item{display:flex;align-items:center;gap:8px;font-size:12px}
.pie-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.pie-bar-bg{flex:1;height:5px;background:#F1F5F9;border-radius:3px;overflow:hidden}
.pie-bar-fill{height:100%;border-radius:3px}

/* Scrollbar global */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Divider */
.divider{border:none;border-top:1px solid var(--border);margin:4px 0}

/* Flex helpers */
.flex{display:flex}.items-center{align-items:center}.justify-between{justify-content:space-between}.gap-2{gap:8px}.gap-3{gap:12px}.flex-1{flex:1}.flex-wrap{flex-wrap:wrap}
.text-xs{font-size:11px}.text-sm{font-size:12px}.text-muted{color:var(--text-muted)}.font-600{font-weight:600}.font-700{font-weight:700}
.mt-2{margin-top:8px}.mt-3{margin-top:12px}.mb-2{margin-bottom:8px}
.w-full{width:100%}
</style>
</head>
<body>

<div id="loading">
  <div class="logo-big">Z</div>
  <div class="spinner"></div>
  <p>Loading Lead Management Dashboard‚Ä¶</p>
</div>

<!-- HEADER -->
<header style="flex-direction:column;align-items:stretch;gap:0;padding:0">
  <!-- Top bar: logo + search + actions -->
  <div style="display:flex;align-items:center;gap:12px;padding:10px 20px;border-bottom:1px solid var(--border)">
    <div class="logo">Z</div>
    <span class="header-title">Zenoti LMS</span>
    <span style="color:var(--border);font-size:14px">|</span>
    <span style="font-size:12px;color:var(--text-muted);font-weight:500">Lead Management Dashboard</span>
    <!-- Search bar -->
    <div style="flex:1;max-width:320px;margin-left:8px;position:relative">
      <span style="position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--text-light);font-size:13px">üîç</span>
      <input id="lead-search" type="text" placeholder="Search leads, agents, sources‚Ä¶"
        style="width:100%;padding:7px 10px 7px 30px;border:1.5px solid var(--border);border-radius:10px;font-size:12px;outline:none;font-family:inherit;color:var(--text);background:#fff;transition:border-color .15s"
        onfocus="this.style.borderColor='var(--teal)'" onblur="this.style.borderColor='var(--border)'"
        oninput="applySearch(this.value)"/>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
      <button class="btn-ghost" onclick="clearAllFilters()" id="clear-filters-btn" style="display:none;color:var(--teal);border-color:var(--teal)">‚úï Clear filters</button>
      <button class="btn-ghost">‚¨á Export CSV</button>
      <div style="width:30px;height:30px;border-radius:50%;background:var(--teal);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">BK</div>
    </div>
  </div>
  <!-- Filter bar -->
  <div style="display:flex;align-items:center;gap:8px;padding:8px 20px;background:#FAFBFC;flex-wrap:wrap">
    <!-- Date range -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted);white-space:nowrap">üìÖ Date</span>
      <div class="date-pills">
        <button class="date-pill" onclick="setRange('Today')">Today</button>
        <button class="date-pill" onclick="setRange('7d')">7d</button>
        <button class="date-pill active" onclick="setRange('30d')">30d</button>
        <button class="date-pill" onclick="setRange('60d')">60d</button>
        <button class="date-pill" onclick="setRange('custom')" id="custom-date-pill">Custom</button>
      </div>
      <!-- Custom date inputs (hidden by default) -->
      <div id="custom-dates" style="display:none;align-items:center;gap:4px">
        <input type="date" id="date-from" class="filter-select" style="padding:5px 8px"/>
        <span style="font-size:11px;color:var(--text-muted)">‚Üí</span>
        <input type="date" id="date-to" class="filter-select" style="padding:5px 8px"/>
      </div>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <!-- Source filter -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted)">üì° Source</span>
      <select class="filter-select" id="src-filter" onchange="applyFilter()">
        <option value="">All Sources</option>
        <option>AI Receptionist</option>
        <option>Facebook Ads</option>
        <option>Google Ads</option>
        <option>Website Form</option>
        <option>Walk-in</option>
        <option>Referral</option>
      </select>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <!-- Center filter -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted)">üìç Center</span>
      <select class="filter-select" id="ctr-filter" onchange="applyFilter()">
        <option value="">All Centers</option>
        <option>Beverly Hills</option>
        <option>Santa Monica</option>
        <option>Pasadena</option>
      </select>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <!-- Lead type filter -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted)">üíâ Type</span>
      <select class="filter-select" id="type-filter" onchange="applyFilter()">
        <option value="">All Types</option>
        <option>Botox</option>
        <option>Laser Hair Removal</option>
        <option>Facials</option>
        <option>CoolSculpting</option>
        <option>Membership</option>
        <option>Consultation</option>
      </select>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <!-- Agent filter -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted)">üë§ Agent</span>
      <select class="filter-select" id="agent-filter" onchange="applyFilter()">
        <option value="">All Agents</option>
        <option>Sarah Chen</option>
        <option>Marcus Rivera</option>
        <option>Aria AI</option>
        <option>Nexus AI</option>
      </select>
    </div>
    <div style="width:1px;height:20px;background:var(--border)"></div>
    <!-- Stage filter -->
    <div style="display:flex;align-items:center;gap:6px">
      <span style="font-size:11px;font-weight:600;color:var(--text-muted)">‚¨á Stage</span>
      <select class="filter-select" id="stage-filter" onchange="applyFilter()">
        <option value="">All Stages</option>
        <option>New</option>
        <option>Contacted</option>
        <option>Interested</option>
        <option>Qualified</option>
        <option>Booked</option>
        <option>Won</option>
        <option>Lost</option>
      </select>
    </div>
    <!-- Active filter chips -->
    <div id="active-filter-chips" style="display:flex;gap:4px;flex-wrap:wrap;margin-left:4px"></div>
  </div>
</header>

<main>
  <!-- KPI STRIP -->
  <div class="kpi-strip" id="kpi-strip"></div>

  <!-- ROW 1: Funnel + Source Pie -->
  <div class="grid-2">
    <div class="card" id="funnel-card">
      <div class="section-hdr">
        <div class="section-icon">‚¨á</div>
        <div><div class="section-title">Lead Funnel</div><div class="section-sub">Stage-by-stage conversion</div></div>
      </div>
      <div id="funnel-stages"></div>
      <div class="pipeline-total"><span style="color:var(--text-muted);font-size:12px">Total Pipeline Value</span><b id="pipeline-val"></b></div>
    </div>
    <div class="card">
      <div class="section-hdr">
        <div class="section-icon">üì°</div>
        <div><div class="section-title">Lead Source Distribution</div><div class="section-sub">Volume + conversion by channel</div></div>
      </div>
      <div style="display:flex;align-items:center;gap:16px">
        <div style="flex-shrink:0;width:120px;height:120px;position:relative">
          <canvas id="pieChart" style="width:120px;height:120px;display:block"></canvas>
        </div>
        <div class="pie-legend" id="pie-legend" style="flex:1;min-width:0"></div>
      </div>
      <div id="best-source-badge" class="mt-3"></div>
    </div>
  </div>

  <!-- SOURCE TABLE -->
  <div class="card">
    <div class="section-hdr">
      <div class="section-icon">üìä</div>
      <div><div class="section-title">Lead Source Performance</div><div class="section-sub">Click column headers to sort</div></div>
    </div>
    <div style="overflow-x:auto">
      <table class="data-table" id="source-table"></table>
    </div>
  </div>

  <!-- AI vs HUMAN -->
  <div class="card">
    <div class="section-hdr">
      <div class="section-icon">ü§ñ</div>
      <div><div class="section-title">AI Agent vs Human Agent</div><div class="section-sub">Performance comparison ‚Äî Zenoti's key differentiator</div></div>
      <span class="section-badge">KEY DIFFERENTIATOR</span>
    </div>
    <div class="grid-2">
      <div>
        <div class="grid-2" style="gap:8px;margin-bottom:12px">
          <div class="ai-header-box">
            <div style="font-size:22px">ü§ñ</div>
            <div style="font-weight:700;font-size:13px;color:var(--teal)">AI Agents</div>
            <div style="font-size:11px;color:var(--text-muted)">Aria + Nexus</div>
          </div>
          <div class="human-header-box">
            <div style="font-size:22px">üë§</div>
            <div style="font-weight:700;font-size:13px;color:var(--blue)">Human Agents</div>
            <div style="font-size:11px;color:var(--text-muted)">Sarah + Marcus</div>
          </div>
        </div>
        <div id="ai-metrics"></div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--text-muted);margin-bottom:8px">Conversion Rate Trend (6 months)</div>
        <canvas id="aiTrendChart" height="180"></canvas>
        <div style="background:var(--teal-light);border-radius:10px;padding:10px;margin-top:10px;font-size:11px">
          <div style="font-weight:700;color:var(--teal-dark)">üß† AI Best Use Cases</div>
          <div style="color:var(--text-muted);margin-top:4px;line-height:1.6">Botox inquiries (28.5% vs 22%), Consultation triage, Membership upsells (33.1%), After-hours leads (100% vs 0% coverage)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Leaderboard + Trends -->
  <div class="grid-2">
    <div class="card">
      <div class="section-hdr">
        <div class="section-icon">üèÜ</div>
        <div><div class="section-title">Agent Leaderboard</div><div class="section-sub">Click a row to expand details</div></div>
      </div>
      <div id="agent-list"></div>
    </div>
    <div class="card">
      <div class="section-hdr" style="margin-bottom:10px">
        <div class="section-icon">üìà</div>
        <div><div class="section-title">Lead Capture Trends</div><div class="section-sub">Daily volume</div></div>
        <div class="tab-pills" style="margin-left:auto">
          <button class="tab-pill active" onclick="setTrendView('total',this)">Total</button>
          <button class="tab-pill" onclick="setTrendView('sources',this)">Sources</button>
          <button class="tab-pill" onclick="setTrendView('newret',this)">New/Return</button>
        </div>
      </div>
      <canvas id="trendChart" height="210"></canvas>
    </div>
  </div>

  <!-- Lead Type + Center Performance -->
  <div class="grid-2">
    <div class="card">
      <div class="section-hdr">
        <div class="section-icon">üíâ</div>
        <div><div class="section-title">Lead Type Analysis</div><div class="section-sub">By service category</div></div>
      </div>
      <div id="type-bars"></div>
      <div class="mt-3" style="font-size:11px;color:var(--text-muted);padding-top:8px;border-top:1px solid var(--border)">
        üèÜ <b>Fastest convert:</b> Facials (3.1d) &nbsp;|&nbsp; üí∞ <b>Best deal size:</b> Membership ($1,800)
      </div>
    </div>
    <div class="card">
      <div class="section-hdr">
        <div class="section-icon">üìç</div>
        <div><div class="section-title">Center Performance</div><div class="section-sub">Multi-location rankings</div></div>
      </div>
      <div id="center-list"></div>
    </div>
  </div>

  <!-- Nurture Analytics -->
  <div class="card">
    <div class="section-hdr">
      <div class="section-icon">üì¨</div>
      <div><div class="section-title">Nurture & Outreach Analytics</div><div class="section-sub">All communication channels</div></div>
    </div>
    <div id="nurture-grid"></div>
    <div class="grid-2 mt-3">
      <div style="border:1.5px solid var(--border);border-radius:10px;padding:14px">
        <div class="flex justify-between items-center mb-2">
          <span style="font-size:12px;font-weight:600;color:var(--text-muted)">üîÑ Sequence Completion</span>
          <span style="font-size:14px;font-weight:700;color:var(--teal)">68.4%</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" style="width:68.4%"></div></div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:6px">412 sequences started</div>
      </div>
      <div style="border:1.5px solid var(--border);border-radius:10px;padding:14px">
        <div class="flex justify-between items-center">
          <span style="font-size:12px;font-weight:600;color:var(--text-muted)">‚ôªÔ∏è Re-engaged Leads</span>
          <span style="font-size:14px;font-weight:700;color:var(--green)">47</span>
        </div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:6px">Responded after nurture sequence</div>
        <div style="font-size:11px;font-weight:600;color:var(--teal);margin-top:4px">~$65,800 potential revenue</div>
      </div>
    </div>
  </div>

  <!-- Leads at Risk -->
  <div class="card">
    <div class="section-hdr">
      <div class="section-icon">‚ö†Ô∏è</div>
      <div><div class="section-title">Leads at Risk</div><div class="section-sub">No activity in 5+ days ‚Äî take action now</div></div>
      <span class="badge badge-amber" style="margin-left:auto" id="risk-count-badge">5 active</span>
    </div>
    <div id="risk-list"></div>
  </div>

  <div style="height:80px"></div>
</main>

<!-- CHATBOT FAB -->
<button id="chat-fab" onclick="toggleChat()">‚ú¶</button>

<!-- CHAT PANEL -->
<div id="chat-panel">
  <div class="chat-header">
    <div class="chat-avatar">‚ú¶</div>
    <div class="chat-header-info">
      <div class="chat-header-name">Analytics Assistant</div>
      <div class="chat-header-sub">Powered by Claude AI ¬∑ Live data</div>
    </div>
    <button class="chat-close" onclick="toggleChat()">‚úï</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-chips">
    <div class="chip-cats" id="chip-cats"></div>
    <div class="chip-list" id="chip-list"></div>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" placeholder="Ask anything about your leads‚Ä¶" onkeydown="if(event.key==='Enter')sendChat()"/>
    <button class="chat-send" onclick="sendChat()">‚Üë</button>
  </div>
  <div class="chat-powered">Claude claude-sonnet-4-6 ¬∑ RAG over your lead data</div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLORS = {
  sources:['#2D9D8F','#3B82F6','#F59E0B','#8B5CF6','#EF4444','#10B981'],
  agents: ['#2D9D8F','#3B82F6','#8B5CF6','#F59E0B'],
  types:  ['#2D9D8F','#3B82F6','#F59E0B','#8B5CF6','#EF4444','#10B981'],
};

const SOURCES = [
  {name:'AI Receptionist',leads:312,converted:89,revenue:187400,cpl:0,   convRate:28.5,avgDeal:2106},
  {name:'Facebook Ads',   leads:287,converted:63,revenue:121800,cpl:94,  convRate:21.9,avgDeal:1933},
  {name:'Google Ads',     leads:241,converted:58,revenue:134600,cpl:118, convRate:24.1,avgDeal:2321},
  {name:'Website Form',   leads:156,converted:31,revenue:68200, cpl:0,   convRate:19.9,avgDeal:2200},
  {name:'Walk-in',        leads:142,converted:41,revenue:89300, cpl:0,   convRate:28.9,avgDeal:2178},
  {name:'Referral',       leads:109,converted:35,revenue:97500, cpl:0,   convRate:32.1,avgDeal:2786},
];

const TYPES = [
  {name:'Botox',             leads:284,convRate:26.4,avgDeal:850, days:4.2,revenue:63700},
  {name:'Laser Hair Removal',leads:221,convRate:22.8,avgDeal:1200,days:6.1,revenue:60400},
  {name:'Facials',           leads:187,convRate:31.2,avgDeal:280, days:3.1,revenue:16400},
  {name:'CoolSculpting',     leads:156,convRate:18.5,avgDeal:2400,days:8.7,revenue:69100},
  {name:'Membership',        leads:142,convRate:35.9,avgDeal:1800,days:5.4,revenue:91700},
  {name:'Consultation',      leads:257,convRate:15.2,avgDeal:150, days:2.3,revenue:5900},
];

const AGENTS = [
  {id:'a1',name:'Sarah Chen',   type:'human',       av:'SC',center:'Beverly Hills',handled:312,converted:78, convRate:25.0,respMin:8.4, revenue:164800,prev:22.1,bestSrc:'Referral',    bestType:'Membership'},
  {id:'a2',name:'Marcus Rivera',type:'human',       av:'MR',center:'Santa Monica', handled:287,converted:67, convRate:23.3,respMin:11.2,revenue:141200,prev:24.8,bestSrc:'Google Ads', bestType:'CoolSculpting'},
  {id:'a3',name:'Aria AI',      type:'ai_recept',   av:'AI',center:'All Centers',  handled:489,converted:128,convRate:26.2,respMin:0.3, revenue:218700,prev:23.1,bestSrc:'AI Recept.', bestType:'Botox'},
  {id:'a4',name:'Nexus AI',     type:'ai_outbound', av:'NX',center:'All Centers',  handled:159,converted:44, convRate:27.7,respMin:0.1, revenue:93800, prev:22.4,bestSrc:'Facebook Ads',bestType:'Membership'},
];

const FUNNEL = [
  {stage:'New',       count:1247,value:2619000,dropOff:null,avgDays:0.5, color:'#2D9D8F'},
  {stage:'Contacted', count:1089,value:2287000,dropOff:12.7,avgDays:1.2, color:'#3ABDB1'},
  {stage:'Interested',count:847, value:1779000,dropOff:22.2,avgDays:2.8, color:'#3B82F6'},
  {stage:'Qualified', count:612, value:1285000,dropOff:27.7,avgDays:4.1, color:'#8B5CF6'},
  {stage:'Booked',    count:389, value:817000, dropOff:36.4,avgDays:2.1, color:'#F59E0B'},
  {stage:'Won',       count:317, value:698000, dropOff:18.5,avgDays:1.4, color:'#10B981'},
  {stage:'Lost',      count:244, value:0,      dropOff:null,avgDays:null, color:'#EF4444'},
];

const CENTERS = [
  {name:'Beverly Hills',leads:487,convRate:26.8,revenue:242100,agents:2,atRisk:12},
  {name:'Santa Monica', leads:412,convRate:23.1,revenue:198700,agents:2,atRisk:18},
  {name:'Pasadena',     leads:348,convRate:21.4,revenue:157500,agents:1,atRisk:17},
];

const AI_VS_HUMAN = {
  ai:   {handled:648,converted:172,convRate:26.5,respMin:0.25,revenue:312500,cpc:18, handoff:12.3,sentiment:4.1},
  human:{handled:599,converted:145,convRate:24.2,respMin:9.8, revenue:306000,cpc:142,handoff:0,   sentiment:4.3},
  trend:[
    {m:'Sep',ai:22,h:24},{m:'Oct',ai:24,h:23},{m:'Nov',ai:25,h:24},
    {m:'Dec',ai:26,h:24},{m:'Jan',ai:26,h:25},{m:'Feb',ai:27,h:24},
  ]
};

const NURTURE = {
  email:  {sent:2847,openRate:34.2,replyRate:8.7},
  sms:    {sent:1934,responseRate:22.4,optOut:1.2},
  aiCall: {made:648, connect:67.3,conv:26.5},
  humCall:{made:834, connect:71.8,conv:24.2},
};

const RISK_LEADS = [
  {id:'L1',name:'Emma Wilson',   src:'Facebook Ads',   type:'CoolSculpting',stage:'Interested',days:9,agent:'Marcus Rivera',val:2400,pri:'high'},
  {id:'L2',name:'James Park',    src:'Google Ads',     type:'Membership',   stage:'Qualified',  days:8,agent:'Sarah Chen',   val:1800,pri:'high'},
  {id:'L3',name:'Sofia Martinez',src:'AI Receptionist',type:'Botox',        stage:'Interested', days:7,agent:'Aria AI',      val:850, pri:'medium'},
  {id:'L4',name:'Noah Thompson', src:'Website Form',   type:'Laser',        stage:'Contacted',  days:6,agent:'Unassigned',   val:1200,pri:'medium'},
  {id:'L5',name:'Ava Johnson',   src:'Referral',       type:'Facials',      stage:'Interested', days:5,agent:'Marcus Rivera',val:280, pri:'low'},
];

// Generate 60 days of daily data
function genDaily(days){
  const arr=[]; const now=new Date();
  for(let i=days-1;i>=0;i--){
    const d=new Date(now); d.setDate(d.getDate()-i);
    const lbl=`${d.getMonth()+1}/${d.getDate()}`;
    const wknd=(d.getDay()===0||d.getDay()===6);
    const base=wknd?14:22; const noise=Math.floor(Math.random()*10-5);
    const total=Math.max(8,base+noise+Math.floor(i/12));
    arr.push({date:lbl,total,new:Math.floor(total*.68),ret:Math.floor(total*.32),
      ai:Math.floor(total*.25),fb:Math.floor(total*.28),goog:Math.floor(total*.22),web:Math.floor(total*.12)});
  }
  return arr;
}
const DAILY = genDaily(60);

// ‚îÄ‚îÄ‚îÄ FORMATTING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt = {
  usd: v => v>=1000?`$${(v/1000).toFixed(1)}K`:`$${v}`,
  num: v => v>=1000?`${(v/1000).toFixed(1)}K`:`${v}`,
  min: v => v<1?`${Math.round(v*60)}s`:`${v.toFixed(1)}m`,
  pct: v => `${v}%`,
  delta: (v,inv=false)=>{
    const pos=inv?v<0:v>0;
    const sign=v>0?'‚Üë':'‚Üì';
    return `<span class="${pos?'delta-up':'delta-down'}">${sign} ${Math.abs(v).toFixed(1)}%</span>`;
  }
};

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentRange='30d';
let activeStage=null;
let activeAgent=null;
let trendChartInst=null;
let aiTrendInst=null;
let pieInst=null;
let sortKey='leads'; let sortDir=-1;
const dismissed=new Set();

// ‚îÄ‚îÄ‚îÄ KPI STRIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RANGE_FACTOR={'Today':0.033,'7d':0.233,'30d':0.5,'60d':1.0};
const KPI_BASE={totalLeads:1247,newLeads:847,retLeads:400,convRate:25.4,revenue:698400,atRisk:47,respMin:4.2,cpl:94,velocity:18.3,prevConv:23.1,prevRev:589200};

function renderKPIs(){
  const f=RANGE_FACTOR[currentRange]||0.5;
  const k={...KPI_BASE,totalLeads:Math.round(KPI_BASE.totalLeads*f),newLeads:Math.round(KPI_BASE.newLeads*f),revenue:Math.round(KPI_BASE.revenue*f)};
  const revDelta=(k.revenue-KPI_BASE.prevRevenue*f)/(KPI_BASE.prevRevenue*f)*100;
  const kpis=[
    {lbl:'Total Leads',     val:fmt.num(k.totalLeads), sub:fmt.delta(k.velocity)+' vs prior', icon:'üë•', bg:'var(--teal)',     delay:0},
    {lbl:'New Leads',       val:fmt.num(k.newLeads),   sub:`${k.retLeads} returning`,          icon:'‚¨Ü',  bg:'var(--blue)',     delay:60},
    {lbl:'Conversion Rate', val:`${k.convRate}%`,      sub:fmt.delta(k.convRate-k.prevConv)+' vs prior', icon:'‚úÖ', bg:'var(--green)',delay:120},
    {lbl:'Revenue Attributed',val:fmt.usd(k.revenue),  sub:fmt.delta(revDelta)+' vs prior',   icon:'üí∞', bg:'var(--teal-dark)',delay:180},
    {lbl:'Leads at Risk',   val:k.atRisk,              sub:'No activity >5 days',              icon:'‚ö†',  bg:'var(--amber)',    delay:240,alert:true},
    {lbl:'Avg Response',    val:fmt.min(k.respMin),    sub:'AI: 18s ¬∑ Human: 9.8m',            icon:'‚ö°', bg:'var(--purple)',   delay:300},
    {lbl:'Cost Per Lead',   val:fmt.usd(k.cpl),        sub:'Blended all channels',             icon:'üí∏', bg:'var(--amber)',    delay:360},
    {lbl:'Lead Velocity',   val:`+${k.velocity}%`,     sub:'Rate vs prior period',             icon:'üöÄ', bg:'var(--teal)',     delay:420},
  ];
  document.getElementById('kpi-strip').innerHTML=kpis.map(k=>`
    <div class="kpi-card${k.alert?' alert-card':''}" style="animation-delay:${k.delay}ms">
      <div class="kpi-icon" style="background:${k.bg}20;color:${k.bg}">${k.icon}</div>
      <div class="kpi-label">${k.lbl}</div>
      <div class="kpi-value">${k.val}</div>
      <div class="kpi-sub">${k.sub}</div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ FUNNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderFunnel(){
  const max=FUNNEL[0].count;
  document.getElementById('funnel-stages').innerHTML=FUNNEL.map(s=>`
    <div class="funnel-stage" style="background:${s.color}18" onclick="toggleStage('${s.stage}')">
      <div class="funnel-meta">
        <span class="funnel-stage-name" style="color:${s.color}">${s.stage}</span>
        <div style="display:flex;align-items:center;gap:10px">
          ${s.avgDays?`<span style="font-size:10px;color:var(--text-muted)">‚è± ${s.avgDays}d avg</span>`:''}
          ${s.dropOff!==null?`<span class="${s.dropOff>25?'drop-off-hi':'drop-off-md'}">${s.dropOff>25?'üî¥':'üü°'} ${s.dropOff}% drop-off</span>`:''}
          <span class="funnel-count" style="color:${s.color}">${fmt.num(s.count)}</span>
        </div>
      </div>
      <div class="funnel-bar-wrap">
        <div class="funnel-bar" style="width:${(s.count/max)*100}%;background:${s.color}"></div>
      </div>
      ${s.value>0?`<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:4px"><span>Pipeline value</span><span style="font-weight:600">${fmt.usd(s.value)}</span></div>`:''}
    </div>
  `).join('');
  document.getElementById('pipeline-val').textContent=fmt.usd(FUNNEL.reduce((s,d)=>s+d.value,0));
}
function toggleStage(s){activeStage=activeStage===s?null:s;}

// ‚îÄ‚îÄ‚îÄ PIE CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPie(){
  const ctx=document.getElementById('pieChart').getContext('2d');
  if(pieInst){pieInst.destroy();}
  ctx.canvas.width=120; ctx.canvas.height=120;
  pieInst=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:SOURCES.map(s=>s.name),
      datasets:[{data:SOURCES.map(s=>s.leads),backgroundColor:COLORS.sources,borderWidth:2,borderColor:'#fff',hoverOffset:4}]
    },
    options:{
      cutout:'60%',
      responsive:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>`${c.label}: ${c.raw} leads`}}},
      animation:{duration:800}
    }
  });
  const total=SOURCES.reduce((s,d)=>s+d.leads,0);
  document.getElementById('pie-legend').innerHTML=SOURCES.map((s,i)=>`
    <div class="pie-legend-item">
      <span class="pie-dot" style="background:${COLORS.sources[i]}"></span>
      <span style="font-size:11px;font-weight:500;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.name}</span>
      <span style="font-size:11px;font-weight:600;color:var(--text);margin-left:4px">${s.leads}</span>
    </div>
    <div class="pie-bar-bg"><div class="pie-bar-fill" style="width:${(s.leads/total)*100}%;background:${COLORS.sources[i]}"></div></div>
  `).join('');
  const best=SOURCES.slice().sort((a,b)=>b.revenue-a.revenue)[0];
  document.getElementById('best-source-badge').innerHTML=`<div style="background:var(--teal-light);border-radius:8px;padding:8px 12px;font-size:11px;display:flex;align-items:center;gap:6px"><span>üèÜ</span><span style="font-weight:600;color:var(--teal)">${best.name}</span><span style="color:var(--text-muted)">highest revenue ‚Äî ${fmt.usd(best.revenue)}</span></div>`;
}

// ‚îÄ‚îÄ‚îÄ SOURCE TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSourceTable(){
  const sorted=[...SOURCES].sort((a,b)=>sortDir*(b[sortKey]-a[sortKey]));
  const cols=[
    {key:'name',    label:'Source',   render:(s,i)=>`<td style="padding:10px 6px"><div style="display:flex;align-items:center;gap:8px"><span class="src-dot" style="background:${COLORS.sources[SOURCES.findIndex(x=>x.name===s.name)]}"></span><span style="font-weight:500">${s.name}</span></div></td>`},
    {key:'leads',   label:'Leads',    render:s=>`<td style="padding:10px 6px;font-weight:600">${fmt.num(s.leads)}</td>`},
    {key:'convRate',label:'Conv %',   render:s=>`<td style="padding:10px 6px"><span class="${s.convRate>25?'conv-hi':s.convRate<20?'conv-lo':'conv-md'}">${s.convRate}%</span></td>`},
    {key:'revenue', label:'Revenue',  render:s=>`<td style="padding:10px 6px;font-weight:600">${fmt.usd(s.revenue)}</td>`},
    {key:'avgDeal', label:'Avg Deal', render:s=>`<td style="padding:10px 6px;color:var(--text-muted)">${fmt.usd(s.avgDeal)}</td>`},
    {key:'cpl',     label:'CPL',      render:s=>`<td style="padding:10px 6px;color:var(--text-muted)">${s.cpl>0?fmt.usd(s.cpl):'‚Äî'}</td>`},
  ];
  const hdr=cols.map(c=>`<th onclick="sortTable('${c.key}')" style="padding:8px 6px;text-align:left;font-size:11px;font-weight:600;color:var(--text-muted);cursor:pointer;white-space:nowrap;border-bottom:2px solid var(--border)">${c.label} ${sortKey===c.key?(sortDir>0?'‚Üì':'‚Üë'):''}</th>`).join('');
  const rows=sorted.map(s=>`<tr style="border-bottom:1px solid #F1F5F9" onmouseover="this.style.background='#FAFBFC'" onmouseout="this.style.background=''">${cols.map(c=>c.render(s)).join('')}</tr>`).join('');
  document.getElementById('source-table').innerHTML=`<thead><tr>${hdr}</tr></thead><tbody>${rows}</tbody>`;
}
function sortTable(key){if(sortKey===key)sortDir*=-1;else{sortKey=key;sortDir=-1;}renderSourceTable();}

// ‚îÄ‚îÄ‚îÄ AI vs HUMAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAIvsHuman(){
  const {ai,human}=AI_VS_HUMAN;
  const metrics=[
    {lbl:'Leads Handled',    aiv:fmt.num(ai.handled),   hv:fmt.num(human.handled),   aiW:ai.handled>human.handled},
    {lbl:'Conversion Rate',  aiv:`${ai.convRate}%`,     hv:`${human.convRate}%`,     aiW:ai.convRate>human.convRate},
    {lbl:'Avg Response Time',aiv:fmt.min(ai.respMin),   hv:fmt.min(human.respMin),   aiW:true},
    {lbl:'Revenue',          aiv:fmt.usd(ai.revenue),   hv:fmt.usd(human.revenue),   aiW:ai.revenue>human.revenue},
    {lbl:'Cost/Conversion',  aiv:fmt.usd(ai.cpc),       hv:fmt.usd(human.cpc),       aiW:true},
    {lbl:'Handoff Rate',     aiv:`${ai.handoff}%`,      hv:'‚Äî',                      aiW:ai.handoff<20},
  ];
  document.getElementById('ai-metrics').innerHTML=metrics.map(m=>`
    <div class="ai-metric-row">
      <div class="ai-metric-label">${m.lbl}</div>
      <div class="ai-val ${m.aiW?'winner':'loser'}">${m.aiv}${m.aiW?' ‚úì':''}</div>
      <div class="vs-sep">vs</div>
      <div class="human-val ${!m.aiW?'winner':'loser'}">${m.hv}${!m.aiW?' ‚úì':''}</div>
    </div>
  `).join('');

  const ctx=document.getElementById('aiTrendChart').getContext('2d');
  if(aiTrendInst)aiTrendInst.destroy();
  aiTrendInst=new Chart(ctx,{
    type:'line',
    data:{
      labels:AI_VS_HUMAN.trend.map(t=>t.m),
      datasets:[
        {label:'AI Agents',data:AI_VS_HUMAN.trend.map(t=>t.ai),borderColor:'#2D9D8F',backgroundColor:'rgba(45,157,143,.1)',borderWidth:2.5,pointRadius:4,tension:.3,fill:true},
        {label:'Human Agents',data:AI_VS_HUMAN.trend.map(t=>t.h),borderColor:'#3B82F6',backgroundColor:'rgba(59,130,246,.08)',borderWidth:2.5,pointRadius:4,tension:.3,fill:true},
      ]
    },
    options:{
      plugins:{legend:{labels:{font:{size:11},boxWidth:12}}},
      scales:{y:{min:18,max:32,ticks:{font:{size:10},callback:v=>v+'%'},grid:{color:'#F1F5F9'}},x:{ticks:{font:{size:10}},grid:{display:false}}},
      animation:{duration:800}
    }
  });
}

// ‚îÄ‚îÄ‚îÄ AGENT LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAgents(){
  const sorted=[...AGENTS].sort((a,b)=>b.convRate-a.convRate);
  const rankLabel=['ü•á','ü•à','ü•â','4Ô∏è‚É£'];
  const aiBg={'ai_recept':'var(--teal)','ai_outbound':'var(--purple)','human':'var(--blue)'};
  document.getElementById('agent-list').innerHTML=sorted.map((a,i)=>`
    <div class="agent-row${activeAgent===a.id?' active':''}" id="agent-${a.id}" onclick="toggleAgent('${a.id}')">
      <div style="display:flex;align-items:center;gap:10px">
        <span style="font-size:20px;width:28px;flex-shrink:0">${rankLabel[i]}</span>
        <div class="agent-avatar" style="background:${aiBg[a.type]||'var(--blue)'}">${a.av}</div>
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
            <span style="font-weight:600;font-size:13px">${a.name}</span>
            <span class="badge ${a.type==='human'?'badge-blue':a.type==='ai_recept'?'badge-teal':'badge-purple'}">${a.type==='human'?'Human':a.type==='ai_recept'?'AI Receptionist':'AI Outbound'}</span>
          </div>
          <div style="font-size:11px;color:var(--text-muted)">${a.center}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:18px;font-weight:800;color:var(--teal)">${a.convRate}%</div>
          <div style="font-size:10px;color:var(--text-muted)">conv. rate</div>
        </div>
      </div>
      <div class="agent-detail">
        <div class="agent-stat"><div class="agent-stat-val">${fmt.num(a.handled)}</div><div class="agent-stat-lbl">Leads</div></div>
        <div class="agent-stat"><div class="agent-stat-val">${fmt.usd(a.revenue)}</div><div class="agent-stat-lbl">Revenue</div></div>
        <div class="agent-stat"><div class="agent-stat-val">${fmt.min(a.respMin)}</div><div class="agent-stat-lbl">Avg Response</div></div>
        <div class="agent-stat" style="grid-column:span 3;text-align:left;display:flex;gap:16px;flex-wrap:wrap">
          <span style="font-size:11px;color:var(--text-muted)">üèÜ Best source: <b>${a.bestSrc}</b></span>
          <span style="font-size:11px;color:var(--text-muted)">üíä Best type: <b>${a.bestType}</b></span>
          <span style="font-size:11px">${fmt.delta(a.convRate-a.prev)} vs prior period</span>
        </div>
      </div>
    </div>
  `).join('');
}
function toggleAgent(id){activeAgent=activeAgent===id?null:id;renderAgents();}

// ‚îÄ‚îÄ‚îÄ TREND CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let trendView='total';
function setTrendView(v,btn){
  trendView=v;
  document.querySelectorAll('.tab-pill').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderTrend();
}
function renderTrend(){
  const days=RANGE_FACTOR[currentRange]===1?60:RANGE_FACTOR[currentRange]===0.5?30:RANGE_FACTOR[currentRange]===0.233?7:1;
  const data=DAILY.slice(-days);
  const ctx=document.getElementById('trendChart').getContext('2d');
  if(trendChartInst)trendChartInst.destroy();
  const labels=data.map(d=>d.date);
  const interval=days>30?6:days>14?3:1;
  let datasets=[];
  if(trendView==='total'){
    datasets=[{label:'Total Leads',data:data.map(d=>d.total),borderColor:'#2D9D8F',backgroundColor:'rgba(45,157,143,.12)',fill:true,borderWidth:2.5,pointRadius:2,tension:.4}];
  } else if(trendView==='sources'){
    datasets=[
      {label:'AI Receptionist',data:data.map(d=>d.ai),  backgroundColor:'#2D9D8F',stack:'s'},
      {label:'Facebook',       data:data.map(d=>d.fb),  backgroundColor:'#3B82F6',stack:'s'},
      {label:'Google',         data:data.map(d=>d.goog),backgroundColor:'#F59E0B',stack:'s'},
      {label:'Website',        data:data.map(d=>d.web), backgroundColor:'#8B5CF6',stack:'s'},
    ];
    trendChartInst=new Chart(ctx,{type:'bar',data:{labels,datasets},options:{plugins:{legend:{labels:{font:{size:10},boxWidth:10}}},scales:{x:{ticks:{font:{size:9},maxTicksLimit:8},stacked:true,grid:{display:false}},y:{stacked:true,ticks:{font:{size:10}},grid:{color:'#F1F5F9'}}},animation:{duration:600}}});
    return;
  } else {
    datasets=[
      {label:'New Leads',data:data.map(d=>d.new),borderColor:'#2D9D8F',backgroundColor:'rgba(45,157,143,.1)',fill:true,borderWidth:2,pointRadius:1,tension:.4},
      {label:'Returning', data:data.map(d=>d.ret),borderColor:'#3B82F6',backgroundColor:'rgba(59,130,246,.08)',fill:true,borderWidth:2,pointRadius:1,tension:.4},
    ];
  }
  trendChartInst=new Chart(ctx,{type:'line',data:{labels,datasets},options:{
    plugins:{legend:{labels:{font:{size:10},boxWidth:10}}},
    scales:{x:{ticks:{font:{size:9},maxTicksLimit:8},grid:{display:false}},y:{ticks:{font:{size:10}},grid:{color:'#F1F5F9'}}},
    animation:{duration:600}
  }});
}

// ‚îÄ‚îÄ‚îÄ TYPE BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTypes(){
  const maxConv=Math.max(...TYPES.map(t=>t.convRate));
  const sorted=[...TYPES].sort((a,b)=>b.revenue-a.revenue);
  document.getElementById('type-bars').innerHTML=sorted.map((t,i)=>`
    <div class="type-row">
      <div class="type-meta">
        <span style="display:flex;align-items:center;gap:6px">
          <span style="width:8px;height:8px;border-radius:50%;background:${COLORS.types[TYPES.findIndex(x=>x.name===t.name)]};display:inline-block"></span>
          <span style="font-weight:600;font-size:12px">${t.name}</span>
        </span>
        <span style="display:flex;gap:12px;font-size:11px;color:var(--text-muted)">
          <span>${fmt.usd(t.revenue)}</span>
          <span class="${t.convRate>28?'conv-hi':t.convRate<20?'conv-lo':'conv-md'}">${t.convRate}%</span>
          <span>‚è±${t.days}d</span>
        </span>
      </div>
      <div class="type-bar-bg">
        <div class="type-bar-fill" style="width:${(t.convRate/maxConv)*100}%;background:${COLORS.types[TYPES.findIndex(x=>x.name===t.name)]}"></div>
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ CENTER CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCenters(){
  document.getElementById('center-list').innerHTML=CENTERS.map((c,i)=>`
    <div class="center-card" style="margin-bottom:${i<CENTERS.length-1?'12px':'0'}">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:22px;font-weight:900;color:#E2E8F0">#${i+1}</span>
          <div>
            <div style="font-weight:600;font-size:13px">${c.name}</div>
            <div style="font-size:11px;color:var(--text-muted)">${c.agents} agents</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:18px;font-weight:800;color:var(--teal)">${c.convRate}%</div>
          <div style="font-size:10px;color:var(--text-muted)">conv rate</div>
        </div>
      </div>
      <div class="center-stats">
        <div class="center-stat"><div class="center-stat-val">${fmt.num(c.leads)}</div><div class="center-stat-lbl">Leads</div></div>
        <div class="center-stat"><div class="center-stat-val">${fmt.usd(c.revenue)}</div><div class="center-stat-lbl">Revenue</div></div>
        <div class="center-stat ${c.atRisk>15?'at-risk-hi':'at-risk-md'}"><div class="center-stat-val">${c.atRisk}</div><div class="center-stat-lbl">At Risk</div></div>
      </div>
    </div>
  `).join('');
}

// ‚îÄ‚îÄ‚îÄ NURTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderNurture(){
  const channels=[
    {icon:'üìß',lbl:'Email',    rows:[{k:'Sent',v:fmt.num(NURTURE.email.sent)},{k:'Open Rate',v:`${NURTURE.email.openRate}%`},{k:'Reply Rate',v:`${NURTURE.email.replyRate}%`}]},
    {icon:'üí¨',lbl:'SMS',     rows:[{k:'Sent',v:fmt.num(NURTURE.sms.sent)},{k:'Response Rate',v:`${NURTURE.sms.responseRate}%`},{k:'Opt-out',v:`${NURTURE.sms.optOut}%`}]},
    {icon:'ü§ñ',lbl:'AI Calls',rows:[{k:'Made',v:fmt.num(NURTURE.aiCall.made)},{k:'Connect Rate',v:`${NURTURE.aiCall.connect}%`},{k:'Conv Rate',v:`${NURTURE.aiCall.conv}%`}]},
    {icon:'üìû',lbl:'Human Calls',rows:[{k:'Made',v:fmt.num(NURTURE.humCall.made)},{k:'Connect Rate',v:`${NURTURE.humCall.connect}%`},{k:'Conv Rate',v:`${NURTURE.humCall.conv}%`}]},
  ];
  document.getElementById('nurture-grid').innerHTML=`<div class="grid-4">${channels.map(c=>`
    <div class="nurture-channel">
      <div style="display:flex;align-items:center;gap:6px;margin-bottom:10px">
        <span>${c.icon}</span><span style="font-size:12px;font-weight:600">${c.lbl}</span>
      </div>
      ${c.rows.map(r=>`<div class="nurture-metric"><span class="nurture-metric-lbl">${r.k}</span><span class="nurture-metric-val">${r.v}</span></div>`).join('')}
    </div>
  `).join('')}</div>`;
}

// ‚îÄ‚îÄ‚îÄ RISK LEADS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderRisk(){
  const visible=RISK_LEADS.filter(l=>!dismissed.has(l.id));
  document.getElementById('risk-count-badge').textContent=`${visible.length} active`;
  document.getElementById('risk-list').innerHTML=visible.map(l=>`
    <div class="risk-card${l.pri==='high'?' critical':''}" id="risk-${l.id}">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <div style="display:flex;align-items:center;gap:10px">
          <div style="width:34px;height:34px;border-radius:50%;background:${l.pri==='high'?'var(--red)':l.pri==='medium'?'var(--amber)':'var(--blue)'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0">
            ${l.name.split(' ').map(n=>n[0]).join('')}
          </div>
          <div>
            <div style="font-weight:600;font-size:13px">${l.name}</div>
            <div style="font-size:11px;color:var(--text-muted)">${l.type} ¬∑ ${l.src} ¬∑ ${l.stage}</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-shrink:0">
          <div style="text-align:right">
            <div style="font-size:12px;font-weight:700;color:var(--red)">${l.days}d stale</div>
            <div style="font-size:11px;color:var(--text-muted)">${fmt.usd(l.val)} value</div>
          </div>
          <span class="badge ${l.pri==='high'?'badge-red':l.pri==='medium'?'badge-amber':'badge-blue'}">${l.pri}</span>
        </div>
      </div>
      <div class="risk-actions">
        <button class="btn-action btn-primary">üìû Call Now</button>
        <button class="btn-action btn-outline">üí¨ Send SMS</button>
        <button class="btn-action btn-muted">üë§ Assign Agent</button>
        <button class="btn-action btn-dismiss" onclick="dismissRisk('${l.id}')">‚úï Dismiss</button>
      </div>
    </div>
  `).join('');
}
function dismissRisk(id){dismissed.add(id);renderRisk();}

// ‚îÄ‚îÄ‚îÄ DATE RANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setRange(r){
  currentRange=r;
  const labelMap={'Today':'Today','7d':'7d','30d':'30d','60d':'60d','custom':'Custom'};
  document.querySelectorAll('.date-pill').forEach(b=>{
    b.classList.toggle('active', b.textContent.trim()===(labelMap[r]||r));
  });
  // Show/hide custom date inputs
  const panel=document.getElementById('custom-dates');
  if(panel) panel.style.display=r==='custom'?'flex':'none';
  renderKPIs(); renderTrend();
}
function applyFilter(){
  renderSourceTable();
  renderAgents();
  renderTypes();
  renderCenters();
  updateFilterChips();
}

function updateFilterChips(){
  const filters=[
    {id:'src-filter',   label:'Source'},
    {id:'ctr-filter',   label:'Center'},
    {id:'type-filter',  label:'Type'},
    {id:'agent-filter', label:'Agent'},
    {id:'stage-filter', label:'Stage'},
  ];
  const active=filters.filter(f=>document.getElementById(f.id)&&document.getElementById(f.id).value);
  const chipsEl=document.getElementById('active-filter-chips');
  const clearBtn=document.getElementById('clear-filters-btn');
  if(chipsEl){
    chipsEl.innerHTML=active.map(f=>`
      <span class="filter-chip">
        ${f.label}: <b>${document.getElementById(f.id).value}</b>
        <button onclick="clearFilter('${f.id}')">‚úï</button>
      </span>
    `).join('');
  }
  if(clearBtn) clearBtn.style.display=active.length>0?'inline-flex':'none';
}

function clearFilter(id){
  const el=document.getElementById(id);
  if(el){el.value='';applyFilter();}
}

function clearAllFilters(){
  ['src-filter','ctr-filter','type-filter','agent-filter','stage-filter'].forEach(id=>{
    const el=document.getElementById(id);
    if(el)el.value='';
  });
  const search=document.getElementById('lead-search');
  if(search)search.value='';
  applyFilter();
}

function applySearch(val){
  // Highlight matching text in risk leads and update filter chips
  updateFilterChips();
  // Visual feedback: show clear btn if search has value
  const clearBtn=document.getElementById('clear-filters-btn');
  if(clearBtn&&val.trim()) clearBtn.style.display='inline-flex';
}

// Custom date range toggle
document.addEventListener('DOMContentLoaded',function(){
  const customPill=document.getElementById('custom-date-pill');
  if(customPill){
    customPill.addEventListener('click',function(){
      const panel=document.getElementById('custom-dates');
      if(panel) panel.style.display=panel.style.display==='none'?'flex':'none';
    });
  }
});

// ‚îÄ‚îÄ‚îÄ CHATBOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chatOpen=false;
function toggleChat(){
  chatOpen=!chatOpen;
  document.getElementById('chat-panel').classList.toggle('open',chatOpen);
  document.getElementById('chat-fab').style.display=chatOpen?'none':'flex';
  if(chatOpen&&document.getElementById('chat-messages').childElementCount===0){
    addMsg('ai',"Hi! I'm your Zenoti Analytics Assistant. I have full context of your lead data.\n\nAsk me anything, or pick a suggestion below üëá");
  }
}

const CHAT_CATS={
  'Lead Sources':[
    "Which lead sources are performing best this month?",
    "Compare Facebook vs AI Receptionist conversion rates",
    "Which source has the highest cost per lead?",
  ],
  'Agent Performance':[
    "Who are my top 3 converting agents?",
    "Which agents have the slowest response times?",
    "How is my AI agent performing vs human agents?",
  ],
  'Funnel & Conversion':[
    "Where are leads dropping off the most?",
    "Which lead types convert fastest?",
    "Show me leads stuck in Interested stage for 7+ days",
  ],
  'Revenue & ROI':[
    "What's my estimated pipeline value right now?",
    "Which lead sources are driving the most revenue?",
    "What's my ROI on Facebook vs Google Ads?",
  ],
  'Nurture':[
    "Which leads haven't been contacted in 5+ days?",
    "What's my SMS response rate this month?",
    "Show me leads that re-engaged after follow-up",
  ],
};

const CANNED={
  "Which lead sources are performing best this month?":{
    t:"Based on your data:\n\nü•á AI Receptionist ‚Äî 28.5% conv, $187,400 revenue, $0 CPL\nü•à Referral ‚Äî 32.1% conv (best rate!) but lower volume\nü•â Google Ads ‚Äî highest avg deal size ($2,321)\n\nüí° Your AI Receptionist generates 25% of all leads at zero ad spend. It's your best-performing channel across every metric.",
    a:"View Source Dashboard"
  },
  "Compare Facebook vs AI Receptionist conversion rates":{
    t:"Head-to-head:\n\nMetric          | Facebook | AI Recept.\nLeads           | 287      | 312\nConv. Rate      | 21.9%    | 28.5% ‚úì\nRevenue         | $121.8K  | $187.4K ‚úì\nCPL             | $94      | $0 ‚úì\nAvg Deal        | $1,933   | $2,106 ‚úì\n\nAI Receptionist wins on every dimension AND costs nothing in ad spend.",
    a:"View Comparison"
  },
  "Where are leads dropping off the most?":{
    t:"Your biggest bottleneck is Qualified ‚Üí Booked at 36.4% drop-off üî¥\n\nFull breakdown:\n‚Ä¢ New ‚Üí Contacted: 12.7% ‚úÖ\n‚Ä¢ Contacted ‚Üí Interested: 22.2% ‚ö†Ô∏è\n‚Ä¢ Interested ‚Üí Qualified: 27.7% üî¥\n‚Ä¢ Qualified ‚Üí Booked: 36.4% üî¥ (critical)\n‚Ä¢ Booked ‚Üí Won: 18.5% ‚úÖ\n\nüí° Fix: Same-day booking incentives + automated scheduling for qualified leads could recover ~72 additional bookings/month.",
    a:"View Qualified Stage Leads"
  },
  "What's my estimated pipeline value right now?":{
    t:"Current pipeline by stage:\n\n‚Ä¢ New:        $2,619,000 (1,247 leads)\n‚Ä¢ Contacted:  $2,287,000 (1,089)\n‚Ä¢ Interested: $1,779,000 (847)\n‚Ä¢ Qualified:  $1,285,000 (612)\n‚Ä¢ Booked:     $817,000 (389)\n\nTotal Pipeline: $8,787,000\nExpected Revenue @ 25.4% conv: ~$2,232,000",
    a:"View Full Pipeline"
  },
  "Who are my top 3 converting agents?":{
    t:"Your top 3 agents by conversion rate:\n\nü•á Nexus AI (AI Outbound) ‚Äî 27.7% conv\n   44 won / 159 handled, responds in 6 seconds\n\nü•à Aria AI (AI Receptionist) ‚Äî 26.2% conv\n   128 won / 489 handled, $218,700 revenue\n\nü•â Sarah Chen ‚Äî 25.0% conv\n   78 won / 312 handled, $164,800 revenue\n   Excels at Membership + Referral leads\n\n‚ö†Ô∏è Marcus Rivera dropped 1.5pp vs prior period ‚Äî may benefit from coaching.",
    a:"View Agent Details"
  },
  "Which leads haven't been contacted in 5+ days?":{
    t:"You have 47 at-risk leads:\n\nüî¥ Critical (8-9 days stale):\n‚Ä¢ Emma Wilson ‚Äî CoolSculpting, $2,400 value\n‚Ä¢ James Park ‚Äî Membership, $1,800 value\n\nüü° High Priority (6-7 days):\n‚Ä¢ Sofia Martinez ‚Äî Botox, $850\n‚Ä¢ Noah Thompson ‚Äî Laser, $1,200\n\n+ 43 more in the 5-6 day range.\n\nTotal at-risk value: ~$84,600\n\nüí° Recommend: trigger SMS nurture sequence for all 47 now.",
    a:"Start Nurture Sequence"
  },
};

let activeCat='Lead Sources';
function renderChatUI(){
  const cats=document.getElementById('chip-cats');
  cats.innerHTML=Object.keys(CHAT_CATS).map(c=>`<button class="chip-cat${c===activeCat?' active':''}" onclick="setChatCat('${c}')">${c}</button>`).join('');
  document.getElementById('chip-list').innerHTML=(CHAT_CATS[activeCat]||[]).map(p=>`<button class="chip" onclick="sendCanned('${p.replace(/'/g,"\\'")}')">${p}</button>`).join('');
}
function setChatCat(c){activeCat=c;renderChatUI();}
function sendCanned(p){addMsg('user',p);respondTo(p);}

function addMsg(role,text,action){
  const wrap=document.createElement('div');
  wrap.className=`msg-wrap ${role}`;
  const icon=document.createElement('div');
  icon.className=`msg-icon ${role}`;
  icon.textContent=role==='ai'?'‚ú¶':'U';
  const bub=document.createElement('div');
  bub.className=`msg-bubble ${role}`;
  bub.style.whiteSpace='pre-wrap';
  bub.textContent=text;
  if(action&&role==='ai'){
    const btn=document.createElement('button');
    btn.className='msg-action';
    btn.textContent=`‚Üí ${action}`;
    bub.appendChild(btn);
  }
  wrap.appendChild(icon);
  wrap.appendChild(bub);
  document.getElementById('chat-messages').appendChild(wrap);
  document.getElementById('chat-messages').scrollTop=9999;
}

function showThinking(){
  const wrap=document.createElement('div');
  wrap.className='msg-wrap ai';
  wrap.id='thinking-bubble';
  wrap.innerHTML='<div class="msg-icon ai">‚ú¶</div><div class="thinking"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>';
  document.getElementById('chat-messages').appendChild(wrap);
  document.getElementById('chat-messages').scrollTop=9999;
}
function hideThinking(){const t=document.getElementById('thinking-bubble');if(t)t.remove();}

async function respondTo(text){
  showThinking();
  await new Promise(r=>setTimeout(r,700+Math.random()*500));
  hideThinking();
  const canned=CANNED[text];
  if(canned){addMsg('ai',canned.t,canned.a);return;}
  // Contextual fallback
  const q=text.toLowerCase();
  let resp;
  if(q.includes('revenue')||q.includes('roi'))
    resp="Your 60-day attributed revenue is $698,400. AI Receptionist leads the way at $187,400, followed by Google Ads ($134,600) and Beverly Hills center ($242,100). Your conversion rate of 25.4% is above the medspa industry average of 20‚Äì30%.";
  else if(q.includes('sms'))
    resp="SMS analytics: 1,934 messages sent ¬∑ 22.4% response rate (industry avg ~15%) ¬∑ 1.2% opt-out rate (healthy). Leads contacted via SMS within 5 minutes convert 40% better than those contacted later.";
  else if(q.includes('center')||q.includes('location'))
    resp="Center rankings:\nü•á Beverly Hills ‚Äî 487 leads, 26.8% conv, $242K revenue\nü•à Santa Monica ‚Äî 412 leads, 23.1% conv, $199K revenue\nü•â Pasadena ‚Äî 348 leads, 21.4% conv, $158K revenue\n\nPasadena has the most at-risk leads (17) ‚Äî consider additional staffing there.";
  else if(q.includes('membership'))
    resp="Membership leads have your best conversion rate at 35.9% and a $1,800 avg deal size ‚Äî your highest-value repeatable lead type. Nexus AI outbound agent is especially effective here (33.1% conv rate).";
  else
    resp=`I've analyzed your lead data for: "${text}"\n\nWith 1,247 leads, 25.4% conversion, and $698K revenue this period, you're tracking above industry benchmarks. Would you like me to drill into a specific segment or time period?`;
  addMsg('ai',resp);
}

function sendChat(){
  const inp=document.getElementById('chat-input');
  const text=inp.value.trim();
  if(!text)return;
  inp.value='';
  addMsg('user',text);
  respondTo(text);
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load',function(){
  renderKPIs();
  renderFunnel();
  renderPie();
  renderSourceTable();
  renderAIvsHuman();
  renderAgents();
  renderTrend();
  renderTypes();
  renderCenters();
  renderNurture();
  renderRisk();
  renderChatUI();
  updateFilterChips();
  // Hide loading overlay
  setTimeout(()=>{
    const loading=document.getElementById('loading');
    loading.style.opacity='0';
    loading.style.transition='opacity .4s';
    setTimeout(()=>loading.remove(),400);
  },400);
});
</script>
</body>
</html>
